#!/bin/sh

PROJECT=`basename $0`

arg()
{
	test "$1" = "-n" && NOCHROOT=1
	return 0
}

usage()
{
	echo "usage: $PROJECT [-n] [name]" >&2
	exit 1
}

while echo -n "$1" | grep '^-' >/dev/null; do
	arg $1
	shift
done

NAME=$1
test "$NAME" != "" || NAME="linux"
JAIL=/usr/local/jails/containers/$NAME

xhost +local:$NAME >/dev/null

service linux onestart >/dev/null
service jail onestart $NAME >/dev/null 2>&1

jexec $NAME service linux start


if test "$NOCHROOT" = "1" -o ! -e $JAIL/compat/linux/bin/login; then
	mount -t nullfs -o nocover /tmp $JAIL/tmp
	jexec $NAME login -f root
else
	mount -t nullfs -o nocover /tmp $JAIL/compat/linux/tmp
	jexec $NAME chroot /compat/linux login -f root
fi

service jail onestop $NAME >/dev/null 2>&1
jail-umount-all $NAME
